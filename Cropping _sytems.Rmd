---
title: Workflows for association rule mining with staple food crop indicator species
author: M.G. Walsh, R. Manners, J. Meliyo and J. Rutembuka
date: "`r format(Sys.time(), '%d, %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 1
    fig_caption: true
    css: style.css
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(message = FALSE)
```

# Introduction

Smallholder crop production systems in East Africa are generally [intercropped](https://en.wikipedia.org/wiki/Intercropping) and/or [rotated](https://en.wikipedia.org/wiki/Crop_rotation), rather than [monocropped](https://en.wikipedia.org/wiki/Monocropping). Even quite small, e.g., 0.25 ha, areas will usually contain multiple crops during any given season. It is not possible to gauge nor manage the ensuing agroecological interactions without monitoring where specific staple crops or crop combinations occur in landscapes, or how the associated cropping systems are fluctuating and/or evolving over time in response to changing environmental constraints, local, national or international market conditions, food production policies, and producer / consumer preferences. 

*The main objective of this notebook is to provide starter code for identification of crop production systems in Rwanda and Tanzania. The data include georeferenced observations of the occurrence of: cattle,	sheep, goats, poultry, maize, wheat, sorghum,	rice,	bean,	cowpea,	pigeon pea,	soybean, groundnut, Irish potato,	sweet potato,	cassava, yam, banana, sugarcane, and sunflower. The markdown notebook presented here is maintained on [Github](https://github.com/mgwalsh/RwaSIS/blob/master/Cropping%20_sytems.Rmd), and you can fork and alter it from there for your reference, and as you see fit.*

We will be using [association rule mining](https://en.wikipedia.org/wiki/Association_rule_learning) workflows, based on the concept of strong rules. *"Strong rules"* were introduced by [Agrawal et al., (1993)](https://dl.acm.org/doi/10.1145/170036.170072) in the context of [affinity analysis](https://en.wikipedia.org/wiki/Affinity_analysis). We'll explore these in this notebook to identify cropping systems based on staple crop indicator species that can be used for practical mapping and monitoring applications of staple food crops.

# General data setup

The data we will be using were generated by the [TanSIS]() and [RwaSIS]() projects in Tanzania and Rwanda. They currently consist of >16k georeferenced, time stamped, and photo tagged, field survey observations of staple crops that were observed in 0.25 ha circular plots (~28.2 m radius), in proportion to their national occurrence, between 2015-2021. The spatially representative cropland sampling frames that are used in both currently ongoing national survey data collections are described in [Walsh, Rutebuka and Manners (2021)](https://github.com/mgwalsh/RwaSIS/blob/master/RwaSIS_cropland_sample.Rmd). A field data collection framework (CropScout) has also been posted on [KoboToolbox](https://kobo.humanitarianresponse.info/#/forms/a3jwzkBTtDvdaZJgR6YjAe/), which you can either use directly or modify for your own use with Open Data Kit ([ODK](https://opendatakit.org/)).

To actually run this notebook, you will need to load the R-packages indicated in the chunk directly below to download and assemble the data. You can find all of the documentation of these packages on [CRAN](https://cran.r-project.org/). Note that additional package installs will be needed in the later sections of this notebook. We shall deal with those as they arise.

```{r}
# Package names
packages <- c("osfr", "tidyverse", "leaflet", "htmlwidgets")

# Install packages
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Load packages
invisible(lapply(packages, library, character.only = TRUE))
```

The survey (label) data downloads can be obtained with this next chunk. The chunk (not shown, but in the markdown document) also generates an overview map of where the observations were collected in Tanzania and Rwanda ... you can click and zoom into the individual locations.

```{r, results = 'hide'}
# Create a data folder in  your current working directory
dir.create("Cropping_systems", showWarnings=F)
setwd("./Cropping_systems")
dir.create("Results", showWarnings=F)

# Download crop survey data: https://osf.io/2unc3/
osf_retrieve_file("2unc3") %>% osf_download(conflicts = "overwrite")
staple <- read.table("TZ_RW_staples.csv", header = T, sep = ",")
staple$div <- rowSums(staple[, 5:24]) ## count of number of staples at each survey location
```

```{r, echo = FALSE}
# CropScout sample locations
w <- leaflet() %>%
  setView(lng = mean(staple$lon), lat = mean(staple$lat), zoom = 7) %>%
  addProviderTiles(providers$OpenStreetMap.Mapnik) %>%
  addCircleMarkers(staple$lon, staple$lat, clusterOptions = markerClusterOptions())
w ## plot widget 
```

# Association rule mining

Association rule mining is frequently used answer questions like ... If you walk into a supermarket and buy charcoal, what is the probability that you will also buy steak (or chicken, Bar-B-Que sauce, etc)? It is frequently referred to as [market basket analysis]() in that context. 

To prepare the data that are used here for the association rule mining workflow we will need to do a bit wrangling initially to select and recode the variables of interest with the following. The `[arules](https://www.rdocumentation.org/packages/arules/versions/1.6-8)` package, which we will be using further only processes factor and logical variables. Note that this chunk is a bit ugly, but it works, and we could always convert it into a function as more data with different staple crops become available.

```{r}
# Initially select the variables (columns) of interest
staple_ar <- staple[ , c(1,5:24)]

# This does the recoding bits
staple_ar$survey <- as.factor(staple_ar$survey)
staple_ar$catt <- as.logical(staple_ar$catt)
staple_ar$shee <- as.logical(staple_ar$shee)
staple_ar$goat <- as.logical(staple_ar$goat)
staple_ar$poul <- as.logical(staple_ar$poul)
staple_ar$maiz <- as.logical(staple_ar$maiz)
staple_ar$whea <- as.logical(staple_ar$whea)
staple_ar$sorg <- as.logical(staple_ar$sorg)
staple_ar$rice <- as.logical(staple_ar$rice)
staple_ar$bean <- as.logical(staple_ar$bean)
staple_ar$cpea <- as.logical(staple_ar$cpea)
staple_ar$pige <- as.logical(staple_ar$pige)
staple_ar$soyb <- as.logical(staple_ar$soyb)
staple_ar$gnut <- as.logical(staple_ar$gnut)
staple_ar$pota <- as.logical(staple_ar$pota)
staple_ar$spot <- as.logical(staple_ar$spot)
staple_ar$cass <- as.logical(staple_ar$cass)
staple_ar$yam <- as.logical(staple_ar$yam)
staple_ar$bana <- as.logical(staple_ar$bana)
staple_ar$cane <- as.logical(staple_ar$cane)
staple_ar$sunf <- as.logical(staple_ar$sunf)

# Provides a glimpse of the resulting data structure
glimpse(staple_ar)
```



# Main takeaways

The main takeaways of this notebook are the following:

* 

Any questions, comments or corrections related to this notebook are most welcome via [AFSIS](mailto:mgw.africasoils.info).

# Aside note: Links to staple food recipes

There are some delicious recipes out there for using the staple crops indicated this notebook for meals (some of these are also quite nutritious). Interestingly cooking advisories such as [Supercook](https://www.supercook.com/#/recipes) and [Allrecipes](https://www.allrecipes.com/search/results/?search=) are also using new recommendation algorithms to help provide meal options based on what ingredients you have available, or may want to have available, in your fridge and dry-goods store. If you are a smallholder in East Africa, those ingredients will largely depend on what you are growing on your land and whatever your breakfast, lunch or dinner preferences are. Maybe we (data scientists) should start to work back from what smallholders are currently growing and the attached preferences?


