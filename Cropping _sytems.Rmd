---
title: Workflows for mapping cropping systems using staple food indicator species
author: M.G Walsh, R. Manners, R. Rodríguez Iglesias, J. Meliyo, and J. Rutebuka
date: "`r format(Sys.time(), '%d, %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 2
    fig_caption: true
    css: style.css
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(message = FALSE)
```

# Introduction

The term ["Agroecology"](https://www.agroecologyfund.org/what-is-agroecology) refers to farming that “centers on food production that makes the best use of nature’s goods and services while not damaging those resources.” Agroecological practices are or should be closely linked to near-real-time knowledge about crop (and livestock) combinations, crop sequences and management practices; i.e., ["Cropping  systems"](https://www.sciencedirect.com/topics/agricultural-and-biological-sciences/cropping-system) that are applied on a given field, farm or region over a period of years. 

The prevailing smallholder cropping systems in East Africa often stand in stark contrast to the industrial agricultural practices elsewhere that rely on reduced labor through mechanization, consolidation of farms and fields, the occurrence of large areas of monocrops, and increased external agricultural inputs such as fossil fuels, electricity, irrigation, GMOs, improved / patented seed, chemical fertilizers, lime, pesticides and herbicides. The increased reliance on external inputs in turn usually comes at economic, health / nutritional, environmental and/or [Ecosystem service](https://en.wikipedia.org/wiki/Ecosystem_service) costs to smallholder farmers and rural communities (see [Rockström et al., 2017](https://link.springer.com/article/10.1007/s13280-016-0793-6)). It is not possible to gauge or manage the ensuing agroecological interactions and complexities without knowing where specific cropping systems and the associated crop species are located and how they may be evolving. As to whether agroecological management actually outperforms industrial agriculture in the long-term remains an open question that is largely not supported by adequate data and evidence. We set some reproducible [Staple food](https://en.wikipedia.org/wiki/Staple_food) baselines here to help test this contention in the future, using a relatively large, georeferenced survey dataset from Tanzania and Rwanda. We also point to potential improvements in survey designs and implementation that may be useful in going forward.

*The main objective of this notebook is to provide starter code in [R](https://www.r-project.org/) for classifying and delineating of cropping systems in Tanzania and Rwanda. The data include georeferenced observations of the occurrence of: maize, millet, wheat, sorghum, rice, bean, chickpea / pigeon pea / cowpea (collectively "other pulses"), soybean, groundnut, Irish potatoes, sweet potatoes, cassava and banana / plantain, in addition to livestock as well as the combined presence/absence of numerous other more localized food, oil, beverage and fiber crops. The markdown notebook presented here is maintained on [Github](https://github.com/mgwalsh/RwaSIS/blob/master/Cropping%20_sytems.Rmd), and you can fork and alter it from there for your reference, and as you see fit.*

# General data setup

The data we will be using were generated by the [TanSIS]() and [RwaSIS]() projects located in Tanzania and Rwanda respectively. They consist of 17,599 georeferenced, time stamped, and ground photo tagged, field survey observations of staple crops that have been observed in 0.25 ha circular plots (~28.4 m radius), in proportion to their national occurrence. The spatially representative cropland sampling frames that are used in these ongoing survey data collections are described in [Walsh, Rutebuka and Manners (2021)](https://github.com/mgwalsh/RwaSIS/blob/master/RwaSIS_cropland_sample.Rmd). A field data collection framework (CropScout) has also been posted on [KoboToolbox](https://kobo.humanitarianresponse.info/#/forms/a3jwzkBTtDvdaZJgR6YjAe/), which you can either use directly or modify for your own use with Open Data Kit ([ODK](https://opendatakit.org/)).

## Initial packages

To actually run this notebook, you will need to load the packages indicated in the chunk directly below to download and assemble the data. You can find all of the documentation of these packages on [CRAN](https://cran.r-project.org/). Note that additional, more specialized, package installs will be needed in the later sections of this notebook. We shall deal with those as they arise.

```{r}
# Package names
packages <- c("osfr", "leaflet", "htmlwidgets", "DT", "stargazer", "caret", "caretEnsemble", "mgcv", "MASS", "randomForest", "xgboost", "klaR", "nnet", "dplyr", "doParallel")

# Install packages
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Load packages
invisible(lapply(packages, library, character.only = TRUE))
```

## Data downloads

The survey (label) and gridded (feature) data downloads can be obtained with this next chunk. The chunk (not shown but in the markdown document) also generates an overview map of where the observations were collected in Tanzania and Rwanda ... you can click and zoom into the individual locations.

```{r, results = 'hide'}
# Create a data folder in  your current working directory
dir.create("Cropping_systems", showWarnings=F)
setwd("./Cropping_systems")
dir.create("Results", showWarnings=F)

# Download crop survey data
osf_retrieve_file("md934") %>% osf_download(conflicts = "overwrite")
unzip("TZ_RW_crop_systems.csv.zip", overwrite = T)
crops <- read.table("TZ_RW_crop_systems.csv", header = T, sep = ",")
```

```{r, echo = FALSE}
# CropScout sample locations
w <- leaflet() %>%
  setView(lng = mean(crops$lon), lat = mean(crops$lat), zoom = 6) %>%
  addProviderTiles(providers$OpenStreetMap.Mapnik) %>%
  addCircleMarkers(crops$lon, crops$lat, clusterOptions = markerClusterOptions())
w ## plot widget 
```

## Survey data summaries



## Gridded features



# Graphical models for cropping systems

The aim of this next section is to illustrate an empirical multivariate basis that describes the relevant conditional relationships between the different staple crops with graphical interaction (specifically log-linear) models. The types of models that we will be using are well described and illustrated in [Højsgaard, Edwards and Lauritzen (2012)](https://link.springer.com/book/10.1007/978-1-4614-2299-0) including the code and references therein. There is also an open R tutorial by [Højsgaard (2012)](https://people.math.aau.dk/~sorenh/misc/2012-Oslo-GMwR/GMwR-notes.pdf) available, which you might want to consult.

To run this section of the notebook you will initially need to install the relevant packages. This is a bit of an artform depending on the version of R that you are currently running. Both the [`gRim`](https://cran.r-project.org/web/packages/gRim/index.html) and [`statnet`](https://statnet.org/) packages that we shall be using for these analyses and their visualization have dependencies to other packages e.g., [`bioconductor`](http://www.bioconductor.org/install/), which can be a bit to install tricky depending on their versioning cycle on [CRAN](https://cran.r-project.org/). The next chunks are what worked for us using our current `R.Version()`, but this is likely to change and you may need to adjust accordingly depending on your setup.

## Package installs

```{r, results = 'hide'}
# Install <bioconductor> first ... see: http://www.bioconductor.org/install/
# do this only once
# if (!requireNamespace("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
# BiocManager::install(version = "3.13")

# note that this will query you in the console as to whether to update other associated packages ... (a/s/n). Respond with n if all of the listed packages are up to date.

# Then install and load gRbase, gRim and statnet 
packages <- c("gRbase", "gRim", "statnet")

# Install packages
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}
```

Similarly, the [`statnet`](https://www.rdocumentation.org/packages/statnet/versions/2019.6) package, which we will use for graphical model visualization currently may have some specific installation requirements that you can track on their [Github repository](https://statnet.org/).

## Fitting graphical interaction models

