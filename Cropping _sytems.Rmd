---
title: Workflows for identifying intercropped staple food systems with association rule mining
author: M.G. Walsh, R. Manners, J. Meliyo and J. Rutebuka
date: "`r format(Sys.time(), '%d, %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 2
    fig_caption: true
    css: style.css
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(message = FALSE)
```

# Introduction

Staple food crops make up the dominant part of a population's diet. There are >50,000 edible plants in the world; however, just 15 of these provide ~90% of the world's [food energy intake (FEI)](https://www.sciencedirect.com/topics/agricultural-and-biological-sciences/food-energy). Rice, maize, and wheat alone make up ~60% of the world's FEI. Other, more regional/local staples include: millet and sorghum, pulses such as beans, lentils and chickpeas, roots and tubers such as potatoes, cassava, yams, and taro, and animal foods such as meat, fish, and dairy products (see [FAO](http://www.fao.org/3/AC832E/ac832e06.htm)). In turn the specific combinations of staple foods that are consumed by people are thought to have specific population-level nutritional, health as well as environmental outcomes that are not well supported by local evidence. The old adage ["You are what you eat"](https://www.phrases.org.uk/meanings/you-are-what-you-eat.html) also implies a level of personal choice or circumstances in this context.

[Association rule learning (ARL)](https://en.wikipedia.org/wiki/Association_rule_learning) is used answer exploratory questions like: If someone walks into a supermarket and buys charcoal, what is the probability that that person will also buy steak (or chicken, Bar-B-Que sauce, etc)? This is also why it is referred to as [market basket analysis](https://www.sciencedirect.com/topics/computer-science/market-basket-analysis). East African food production systems are analogous to a supermarket situation in that fields are generally [intercropped](https://en.wikipedia.org/wiki/Intercropping) with several staple foods, rather than [monocropped](https://en.wikipedia.org/wiki/Monocropping). Even quite small, 0.25 ha cropland areas will commonly be planted with multiple staple food crops during any given season. However, which specific crops are grown together in a given small area or environment, and how these combinations may be evolving due to external factors remain uncertain and largely unquantified. We'll use ARL in this notebook to identify intercropped systems based on the occurrence of staple crop indicator species that can subsequently be used for practical mapping and monitoring applications.

*The main objective of this notebook is to introduce starter code for identification of staple food systems in Rwanda and Tanzania. The data include georeferenced observations of the occurrence of: cattle, sheep, goats, poultry, maize, wheat, sorghum, rice, bean, cowpea, pigeon pea, soybean, groundnut, Irish potato, sweet potato, cassava, yam, banana, sugarcane, and sunflower. The markdown notebook presented here is maintained on [Github](https://github.com/mgwalsh/RwaSIS/blob/master/Cropping%20_sytems.Rmd), and you can fork and alter it from there for your reference, and as you see fit.*

# General data setup

The example data we will be using were generated by the [TanSIS](https://doi.org/10.17605/OSF.IO/4NGAU) and [RwaSIS](https://doi.org/10.17605/OSF.IO/Y9ZUT) projects in Tanzania and Rwanda. They currently consist of >16k georeferenced, time stamped, and photo tagged, field survey observations of staple crops that were observed in 0.25 ha circular plots (~28.2 m radius), in proportion to their national occurrence, between 2015-2021. The spatially representative cropland sampling frames that are used in both currently ongoing national survey data collections are described in [Walsh, Rutebuka and Manners (2021)](https://github.com/mgwalsh/RwaSIS/blob/master/RwaSIS_cropland_sample.Rmd). A field data collection framework (CropScout) has also been posted on [KoboToolbox](https://kobo.humanitarianresponse.info/#/forms/a3jwzkBTtDvdaZJgR6YjAe/), which you can either use directly or modify for your own use with Open Data Kit ([ODK](https://opendatakit.org/)).

To actually run this notebook, you will need to load the R-packages that are indicated in the chunk directly below to download and assemble the data. You can find all of the documentation of these packages on [CRAN](https://cran.r-project.org/). Note that additional package installs will be needed to run the later sections of this notebook. We shall deal with those as they arise.

```{r}
# Package names
packages <- c("osfr", "tidyverse", "leaflet")

# Install packages
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Load packages
invisible(lapply(packages, library, character.only = TRUE))
```

The survey (label) data downloads can be obtained with this next chunk. It also generates an overview map of where the observations were collected in Tanzania and Rwanda (not shown, but in the markdown document) ... you can click and zoom into the individual locations, which have been surveyed thus far.

```{r, results = 'hide'}
# Create a data folder in  your current working directory
dir.create("Food_system", showWarnings=F)
setwd("./Food_system")
dir.create("Results", showWarnings=F)

# Download crop survey data: https://osf.io/2unc3/
osf_retrieve_file("2unc3") %>% osf_download(conflicts = "overwrite")
staple <- read.table("TZ_RW_staples.csv", header = T, sep = ",")
staple$sdiv <- rowSums(staple[, 6:25]) ## count of number of staples at each survey location
```

```{r, echo = FALSE}
# CropScout sample locations
w <- leaflet() %>%
  setView(lng = mean(staple$lon), lat = mean(staple$lat), zoom = 6) %>%
  addProviderTiles(providers$OpenStreetMap.Mapnik) %>%
  addCircleMarkers(staple$lon, staple$lat, clusterOptions = markerClusterOptions())
w ## plot widget 
```

To prepare the data that are used here for the association rule mining workflow we will need to do a bit wrangling initially to select and recode the variables of interest. The [`arules`](https://www.rdocumentation.org/packages/arules/versions/1.6-8) package, which we will be using further below only processes factor and logical variables. Note that this chunk is a bit ugly, but it works, and we could always convert it into a proper function as more data with different staple crops or from different places become available.

```{r}
# Initially select the variables (columns) of interest
staple_ar <- staple[ , c(3:4,1,5:25,27)]

# This does the recoding bits
staple_ar$survey <- as.factor(staple_ar$survey)
staple_ar$build <- as.logical(staple_ar$build)
staple_ar$catt <- as.logical(staple_ar$catt)
staple_ar$shee <- as.logical(staple_ar$shee)
staple_ar$goat <- as.logical(staple_ar$goat)
staple_ar$poul <- as.logical(staple_ar$poul)
staple_ar$maiz <- as.logical(staple_ar$maiz)
staple_ar$whea <- as.logical(staple_ar$whea)
staple_ar$sorg <- as.logical(staple_ar$sorg)
staple_ar$rice <- as.logical(staple_ar$rice)
staple_ar$bean <- as.logical(staple_ar$bean)
staple_ar$cpea <- as.logical(staple_ar$cpea)
staple_ar$pige <- as.logical(staple_ar$pige)
staple_ar$soyb <- as.logical(staple_ar$soyb)
staple_ar$gnut <- as.logical(staple_ar$gnut)
staple_ar$pota <- as.logical(staple_ar$pota)
staple_ar$spot <- as.logical(staple_ar$spot)
staple_ar$cass <- as.logical(staple_ar$cass)
staple_ar$yam  <- as.logical(staple_ar$yam)
staple_ar$bana <- as.logical(staple_ar$bana)
staple_ar$cane <- as.logical(staple_ar$cane)
staple_ar$sunf <- as.logical(staple_ar$sunf)
staple_ar$inter <- as.factor(ifelse(staple_ar$sdiv > 1, "TRUE", "FALSE"))

# Generates a glimpse of the resulting dataframe
glimpse(staple_ar)
```

The crop variables indicate the occurrence (`TRUE/FALSE`) of: cattle, sheep, goats, poultry, maize, wheat, sorghum, rice, bean, cowpea, pigeon pea, soybean, groundnut, Irish potato, sweet potato, cassava, yam, banana, sugarcane, and sunflower. There are also variables identifying the lat/lon (EPSG:3857) of the survey observations, if buildings were present within 50 m radius of the recorded survey location (`TRUE/FALSE`), and the number of staple crops that were observed in the respective 0.25 ha cropland quadrats (0 - 12). Intercropped systems contain at least 2 staples. You can then write out the wrangled dataframe, should you wish to use it in other applications.

```{r}
# Write out tidy dataframe
write.csv(staple_ar, "./Food_system/Results/TZ_RW_staple_food.csv")
```

# Association rules

We will be using a workflow based on the concept of strong rules. *"Strong rules"* were introduced by [Agrawal et al., (1993)](https://dl.acm.org/doi/10.1145/170036.170072) in the context of [affinity analysis](https://en.wikipedia.org/wiki/Affinity_analysis). There are two main summary quantities of interest in the application of strong rules: *support* and *confidence*.

* Support tells us the probability of the instances where combinations of crops A and B (C,D, ...) occur together. This helps identify and contrast combinations that are sufficiently frequent to be of interest (e.g., growing maize alone, versus growing maize in combination with various other crops). Conversely, it also tells us about the probability of combinations that may be rare (*sensu* outliers).

* Confidence tells us which proportion of instances that have staple A and also have staple B (C,D, ...) e.g., the conditional probability of instances that have maize also have bean, cattle, etc.

Typically, association rules are considered to be interesting if at minimum they satisfy both a support threshold and a confidence threshold. Both the support and confidence thresholds can/should be set by subject matter specialists e.g., agronomists and/or nutritionists. Other threshold metrics e.g., ([Lift](https://en.wikipedia.org/wiki/Lift_(data_mining)) might also be considered when deciding if a given rule is of interest or not, but these can generally also be calculated from the relevant support and confidence measures. There are some good, short tutorials available on YouTube that you might want to consult in this context (e.g., https://www.youtube.com/watch?v=WGlMlS_Yydk). 

## Rule discovery and exploratory analyses



## Association rule mining

# Main takeaways

The main takeaways of this notebook are the following:

*  There are certainly other analysis options such as [graphical interaction models]() that we could use for the data example that we presented here. We have not included these in this notebook to keep things relatively concise, but we might explore those options in an additional notebook at a later stage.

*

Any questions, comments or corrections related to this notebook are most welcome via [AFSIS](mailto:mgw.africasoils.info).

# Aside note: Links to staple food recipes

Of course there are some delicious recipes out there for using the staple crops indicated this notebook for meals (some of these are also quite nutritious). Interestingly cooking advisories such as [Supercook](https://www.supercook.com/#/recipes) and [Allrecipes](https://www.allrecipes.com/search/results/?search=) are also using new recommendation algorithms to help provide meal options based on what ingredients you have available, or what you may want to have available, in your fridge and dry-goods store. If you are a smallholder in East Africa, those ingredients will largely depend on what you are growing on your land and whatever your breakfast, lunch or dinner preferences are. It might be interesting and informative to do a webscrape of recipe sites to see to what degree the staple foods explored here occur in African and global food recipes. We shall leave that for another day. 


