---
title: Workflows for predicting staple food systems with association rule mining
author: M.G. Walsh, R. Manners, J. Meliyo, J. Rutebuka and M. Broadley
date: "`r format(Sys.time(), '%d, %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 2
    fig_caption: true
    css: style.css
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

# Introduction

Staple foods make up the dominant food energy intake in a population's diet. While there are >50,000 edible plants in the world, just 15 of these provide ~90% of the world's [gross food energy (GE)](https://www.sciencedirect.com/topics/agricultural-and-biological-sciences/food-energy). Rice, maize, and wheat alone make up ~60% of the world's GE. Other, more regional/local staples include: millet and sorghum, pulses such as beans, lentils and chickpeas, roots and tubers such as potatoes, cassava, yams, and taro, and animal foods such as meat, fish, and dairy products (see [FAO](http://www.fao.org/3/AC832E/ac832e06.htm)). In turn the specific combinations of staple foods that are consumed by people are thought to have specific population-level nutritional, health as well as environmental outcomes that are not well supported by local evidence. The old adage ["You are what you eat"](https://www.phrases.org.uk/meanings/you-are-what-you-eat.html) also implies a level of personal circumstances and choices in this regard.

[Association rule learning (ARL)](https://en.wikipedia.org/wiki/Association_rule_learning) is used to answer common exploratory questions like: If someone walks into a supermarket and buys charcoal, what is the probability that this person will also buy steak (or chicken and Bar-B-Que sauce, etc)? This is also why it is often referred to as [market basket analysis](https://www.sciencedirect.com/topics/computer-science/market-basket-analysis). 

The majority of East African food production systems are analogous to a supermarket situation in that fields are [intercropped](https://en.wikipedia.org/wiki/Intercropping) with several staple food crops, rather than [monocropped](https://en.wikipedia.org/wiki/Monocropping). Even quite small, 0.25 ha, cropland areas will commonly be planted with multiple staple food crops during any given season. However, which specific crops are grown together in a given small area or environment, and how these combinations may be evolving due to external factors remain uncertain and largely unquantified. We'll use ARL in this notebook to explore staple food systems based on the occurrence of crop indicator species that can subsequently be used for practical mapping and monitoring applications. There is also the [*"Bear Grylls"*](https://www.beargrylls.com/) analogy that poses a similar question in that if you observe chickens and banana what is the probability that you are close to buildings in a remote area of East Africa? It turns out that the odds of that are pretty good, though the the likelihood of encountering such a situation is not!

*The main objective of this notebook is to introduce starter code for exploration, discovery and identification of staple food systems in Tanzania and Rwanda. The data include georeferenced observations of the occurrence of: cattle, sheep, goats, poultry, maize, wheat, sorghum, rice, bean, cowpea, pigeon pea, soybean, groundnut, Irish potato, sweet potato, cassava, yam, banana, sugarcane, and sunflower. The markdown notebook presented here is maintained on [Github](https://github.com/mgwalsh/RwaSIS/blob/master/Cropping%20_sytems.Rmd), and you can fork and alter it from there for your reference, and as you see fit.*

# General data setup

The example data we will be using were generated by the [TanSIS](https://doi.org/10.17605/OSF.IO/4NGAU) and [RwaSIS](https://doi.org/10.17605/OSF.IO/Y9ZUT) projects in Tanzania and Rwanda. They currently consist of >16k georeferenced, time stamped, and photo tagged, field survey observations of staple crops that were observed in 0.25 ha circular primary sampling units (PSU, ~28.2 m radius), in proportion to their national occurrence, between 2015-2021. The spatially representative cropland sampling frames that are used in both currently ongoing national survey data collections are described in [Walsh, Rutebuka and Manners (2021)](https://github.com/mgwalsh/RwaSIS/blob/master/RwaSIS_cropland_sample.Rmd). A field data collection framework (CropScout) has also been posted on [KoboToolbox](https://kobo.humanitarianresponse.info/#/forms/a3jwzkBTtDvdaZJgR6YjAe/), which you can either use directly or modify for your own use with Open Data Kit ([ODK](https://opendatakit.org/)).

To actually run this notebook, you will need to load the R-packages that are indicated in the chunk directly below to download, assemble and model the data. You can find all of the documentation of these packages on [CRAN](https://cran.r-project.org/).

```{r}
# Package names
packages <- c("osfr", "tidyverse", "leaflet", "arules", "arulesViz", "caret", "arulesCBA")

# Install packages
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Load packages
invisible(lapply(packages, library, character.only = TRUE))
```

The survey (label) data downloads can be obtained with this next chunk. It also generates an overview map of where the PSUs were collected in Tanzania and Rwanda (not shown, but in the markdown document) ... you can click and zoom into the individual locations that we have surveyed thus far.

```{r, results = 'hide'}
# Create a data folder in  your current working directory
dir.create("Food_system", showWarnings=F)
setwd("./Food_system")
dir.create("Results", showWarnings=F)

# Download crop survey data: https://osf.io/2unc3/
osf_retrieve_file("2unc3") %>% osf_download(conflicts = "overwrite")
staple <- read.table("TZ_RW_staples.csv", header = T, sep = ",")
staple$sdiv <- rowSums(staple[, 6:25]) ## count of number of staples at each survey location
```

```{r, echo = FALSE}
# CropScout sample locations
w <- leaflet() %>%
  setView(lng = mean(staple$lon), lat = mean(staple$lat), zoom = 6) %>%
  addProviderTiles(providers$OpenStreetMap.Mapnik) %>%
  addCircleMarkers(staple$lon, staple$lat, clusterOptions = markerClusterOptions())
w ## plot widget 
```

To prepare the data that are used here for the association rule mining workflow we will need to do a bit wrangling initially to select and recode the variables of interest. The [`arules`](https://www.rdocumentation.org/packages/arules/versions/1.6-8) package, which we will be using further below, only processes factor and logical variables. Note that this chunk is a bit ugly, but it works, and we could always convert it into a proper function as more data with different staple crops or from different places become available.

```{r}
# Initially select the variables (columns) of interest
staple_ar <- staple[ , c(3:4,1,5:25,27)]

# This does the recoding bits
staple_ar$survey <- as.factor(staple_ar$survey)
staple_ar$build <- as.factor(ifelse(staple_ar$build == 1, "present", "absent"))
staple_ar$catt <- as.logical(staple_ar$catt)
staple_ar$shee <- as.logical(staple_ar$shee)
staple_ar$goat <- as.logical(staple_ar$goat)
staple_ar$poul <- as.logical(staple_ar$poul)
staple_ar$maiz <- as.logical(staple_ar$maiz)
staple_ar$whea <- as.logical(staple_ar$whea)
staple_ar$sorg <- as.logical(staple_ar$sorg)
staple_ar$rice <- as.logical(staple_ar$rice)
staple_ar$bean <- as.logical(staple_ar$bean)
staple_ar$cpea <- as.logical(staple_ar$cpea)
staple_ar$pige <- as.logical(staple_ar$pige)
staple_ar$soyb <- as.logical(staple_ar$soyb)
staple_ar$gnut <- as.logical(staple_ar$gnut)
staple_ar$pota <- as.logical(staple_ar$pota)
staple_ar$spot <- as.logical(staple_ar$spot)
staple_ar$cass <- as.logical(staple_ar$cass)
staple_ar$yam  <- as.logical(staple_ar$yam)
staple_ar$bana <- as.logical(staple_ar$bana)
staple_ar$cane <- as.logical(staple_ar$cane)
staple_ar$sunf <- as.logical(staple_ar$sunf)
staple_ar$sdic <- discretize(staple_ar$sdiv, method = "fixed", breaks = c(0,1,2,12), labels = c("none", "mono", "inter"))

# Generates a glimpse of the resulting dataframe
glimpse(staple_ar)
```

The crop variables indicate the occurrence (`TRUE/FALSE`) of: cattle, sheep, goats, poultry, maize, wheat, sorghum, rice, bean, cowpea, pigeon pea, soybean, groundnut, Irish potato, sweet potato, cassava, yam, banana, sugarcane, and sunflower. There are also variables identifying the lat/lon (EPSG:3857) of the survey observations, if buildings were present within 50 m radius of the recorded survey location (`TRUE/FALSE`), and the number of staple crops that were observed in the respective 0.25 ha cropland quadrats (0 - 12). Systems where staple diversity `sdiv = 0` are croplands that do not contain any of the staple crops described here. These include other crops such as tea, coffee, pineapple, sisal plantations, orchards, etc. Intercropped systems (`inter = TRUE`) contain at least 2 staple crops. You can write out the wrangled dataframe should you wish to use it in other applications, with:.

```{r}
# Write out tidy dataframe
write.csv(staple_ar, "./Food_system/Results/TZ_RW_staple_food.csv")
```

# Exploratory data analyses

This section provides some initial EDAs for these data. One could also do this with R-base and/or `dplyr`, but the [`arules`](https://www.rdocumentation.org/packages/arules/versions/1.6-8) package provides some useful wrapper functions for this, which run quickly.

```{r}
# Select initial crop occurrence variables and convert these to "transactions"
crops <- staple_ar[ , c(5:24)]
trans <- as(crops, "transactions")
```

```{r, fig.align = "center", fig.height = 4, fig.width = 7, fig.cap = "Overall support for individual staple food crop occurrences in Tanzania and Rwanda."}

itemFrequencyPlot(trans, topN = 20, ylab = "Support (rel. frequency)", cex.lab = 1.2)
```

The graph provides an indication of the overall level of support for the individual staple crops that are presented here. Maize is the most frequent, yam is the most infrequent. This means that various staple combinations with maize are likely to have more overall support than any crop combinations with yam. You can also subset the data for comparison, e.g. by survey, with something like the following:

```{r}
# Rwanda subset
crops_RW <- staple_ar[which(staple_ar$survey == 'RW'), ]
crops_RW <- crops_RW[ , c(5:24)]
trans_RW <- as(crops_RW, "transactions")

# Tanzania subset
crops_TZ <- staple_ar[which(staple_ar$survey == 'TZ'), ]
crops_TZ <- crops_TZ[ , c(5:24)]
trans_TZ <- as(crops_TZ, "transactions")
```

You can then plot the staple crop-level support comparison for the 2 surveys with:

```{r fig.align = "center", fig.show = 'hold', fig.height = 8 , fig.width = 7, fig.cap = "Differences in support for staple food crop occurrences in Tanzania and Rwanda."}

par(mfrow = c(2,1))
itemFrequencyPlot(trans_TZ, ylab = "Support (rel. frequency)", main = "Tanzania", 
                  ylim = c(0,0.7), cex.lab = 1.2)
itemFrequencyPlot(trans_RW, ylab = "Support (rel. frequency)", main = "Rwanda", 
                  ylim = c(0, 0.7), cex.lab = 1.2)
```

Based on this, you can to tell that the main staple distributions grown in Tanzania are quite different from those in Rwanda. Also not surprisingly, the [beta-diversity](https://en.wikipedia.org/wiki/Beta_diversity) of staple crop combinations (`sdiv`) between the two national survey samples is also quite different, as is shown in the next plot.

```{r, fig.align = "center", fig.cap = "Conditional staple food crop diversity by survey."}

par(pty = "s")
boxplot(sdiv~survey, notch = T, ylab = "No. of staples per quadrat", xlab = "Country",
        cex.lab = 1.3, staple_ar)
```

This will influence the different intercropped combinations that are likely to occur in the two countries, and those differences would need to be considered in any subsequent mapping and/or staple food distribution monitoring applications. There are good reasons for differences that appear to be primarily associated with the differences of cropland occurrences in proximity to buildings between the two countries.

In general, there are large also diversity differences between staple crops that are grown in proximity to buildings versus those that are grown in more distant/outlying fields, as is shown in the next figure.

```{r, fig.align = "center", fig.cap = "Conditional staple food crop diversity by proximity to buildings indicator."}

par(pty = "s")
boxplot(sdiv~build, notch = T, ylab = "No. of staples per quadrat", xlab = "Buildings within 50 m?",
        cex.lab = 1.3, staple_ar)
```

In this case the differences between the two surveys may simply represent a [confounding variable](https://stats.libretexts.org/Bookshelves/Applied_Statistics/Book%3A_Biological_Statistics_(McDonald)/01%3A_Basics/1.05%3A_Confounding_Variables) that can be accounted for by considering the potentially more causal proximity to buildings in each country. People do tend to plant more diverse staples in proximity to their homes. We will look at this in more detail further below. 

# Association rules

We will be using a workflow based on the concept of strong rules. *"Strong rules"* were introduced by [Agrawal et al., (1993)](https://dl.acm.org/doi/10.1145/170036.170072) in the context of [affinity analysis](https://en.wikipedia.org/wiki/Affinity_analysis). There are three main metrics of interest in the application of strong rules are: *support*, *confidence* and *lift*.

* *Support* tells us the joint probability of instances where crops A and B i.e., `p(A,B)` occur. This helps identify and contrast combinations that are sufficiently frequent to be of interest (e.g., growing maize in combination with various other crops). Conversely, it also tells us about the probability of various combinations that are rare (*sensu* outliers).

* *Confidence* tells us the conditional probability of instances that have staple B given that they have staple A (i.e., `p(B|A)`) e.g., the instances that have bean, cattle, banana, etc, given that they have maize. This also contrasts potentially rare associations such as the probability of e.g., `p(yam|maize)`.

* *Lift* is calculated as the ratio of the joint probability of two crops A and B, divided by the product of their probabilities i.e., `P(A,B)/(P(A)P(B))`. If the two items are statistically independent, then the joint probability of the two items will be the same as the product of their probabilities. In other words, `P(A,B) = P(A)P(B)`, which makes the lift factor = 1. Worth mentioning is that anti-correlations can yield lift values that are less than 1, which correspond to mutually exclusive crops combinations that rarely occur together.

Typically, association rules are considered to be interesting if they satisfy at least both support and confidence thresholds. These thresholds can/should be set by subject matter specialists e.g., agronomists and/or nutritionists. Note that there are some good, short tutorials available on YouTube that you might wish to consult to clarify the terminology in this context (e.g., https://www.youtube.com/watch?v=WGlMlS_Yydk). 

## Association rule mining

We can explore the various staple crop combinations with the `apriori` algorithm in the [`arules`](https://www.rdocumentation.org/packages/arules/versions/1.6-8) package. We step through various rule sets here. These are not intended to be exhaustive, but they will provide you with some realistic options for tuning the `apriori` algorithm appropriately for discovering potentially association interesting rules. In this first chunk we identify the most common intercropped systems for which we have at least 1,000 observations across the two surveys.

```{r, results = FALSE}
mins <- 1000/nrow(trans) ## set minimum support threshold

# Baseline itemset
basef <- apriori(trans, parameter = list(target = "frequent", support = mins, minlen = 2))
``` 

```{r}
inspectDT(basef) ## table of the 27 most common intercropped systems in Tanzania and Rwanda.
```

We also plot the corresponding association graph with:

```{r, fig.align ='center', fig.width = 9, fig.cap = "Baseline association graph of the 27 most frequent intercropping systems in Tanzania and Rwanda."}

plot(basef, method = "graph")
```

We can also split this between the national surveys of the two countries with:

```{r, results = FALSE}
rwf <- apriori(trans_RW, parameter = list(target = "frequent", support = mins, minlen = 2))
tzf <- apriori(trans_TZ, parameter = list(target = "frequent", support = mins, minlen = 2))
```

```{r, fig.align = "center", fig.show = 'hold', fig.height = 5 , fig.width = 9, fig.cap = "Staple food crop association graphs for Tanzania (top) and Rwanda (bottom)."}

par(mfrow = c(2,1))
plot(tzf, method = "graph")
plot(rwf, method = "graph")
```

## Staple crop diversity in proximity to buildings

However, we think that perhaps a better generalization, also for the purposes mapping and monitoring staple food crops, is by referencing where people live in close proximity to the food crops that they produce (e.g. as indexed by their proximity to buildings). In Rwanda most smallholder fields are located close to buildings. In Tanzania croplands are more dispersed over larger areas relative to where people actually reside, reflecting a large difference in the rural population densities between the two countries. We can actually explore this contention here because the occurrence of buildings with a 50 m radius of the PSUs was recorded in both the Tanzania and the Rwanda surveys.

```{r}
# Select crop occurrence variables and buildings and convert these to "transactions"
crops <- staple_ar[ , c(4:24)]
inter <- as(crops, "transactions")
```

```{r, results = FALSE}
buildr <- apriori(inter, parameter = list(target = "rule", support = mins, confidence = 0.5,
                                          minlen = 2))
```

```{r, fig.align = "center", fig.height = 5 , fig.width = 9, fig.cap = "Association rule graph of the main staple food systems in Tanzania and Rwanda."}

plot(buildr, method = "graph")
```

```{r}
# Staple crop systems rule mining summary table
inspectDT(buildr)
```

## Labelling itemsets

One thing that is missing from the `arules` package is a general function for labelling and predicting all combinations of PSUs and staple crops at any particular observed and/or new PSU based on the developed association rules. Fortunately, such a function has already been written by [J. de Jong (2016)](https://johanndejong.wordpress.com/2016/11/22/efficient-recommending-with-the-arules-package/). We have stolen it here because it is elegant and fast.

```{r}

recommend <- function(
  rules, # object with association rules
  newdata # itemMatrix object
) {
    lhs_match <- is.superset(
    newdata,
    lhs(rules),
    sparse = TRUE
  )
  
  rec <- lhs_match %*% t(rhs(rules)@data)
  rownames(rec) <- rownames(newdata)
  colnames(rec) <- colnames(newdata)
  as(t(rec), "itemMatrix")
}
```

We can now use this next chunk to generate the labels based on the developed association rule-base, and a write-out to a dataframe. Of course, this could also be done for any new data.

```{r}
inter <- as(inter, "itemMatrix")
preds <- recommend(buildr, inter)
staples <- DATAFRAME(preds)
staple_ar <- cbind(staple_ar, staples)

# Write out tidy dataframe
write.csv(staple_ar, "./Food_system/Results/TZ_RW_staple_food_rules.csv", row.names = FALSE)

# Generates a glimpse of the resulting dataframe
glimpse(staple_ar)
```

## Using ARL for classification

The approach presented in the next chunks can be used to validate the mined association rules vis-á-vis other machine learning algorithms and/or used in various model ensembles. We use it here to illustrate a strategy, and starter code, for generating predictions of staple food diversity categories with the CBA (Classification Based on Association Rules) algorithm from the [`arulesCBA`](https://www.webpages.uidaho.edu/~stevel/517/arulesCBA.pdf) package.

```{r}

```

# Main takeaways

The main takeaways of this notebook are the following:

* The staple food crop combinations (systems), which are considered in this notebook are already fairly complex, but they will require more learning to unravel completely. We have only scratched the surface here. Nonetheless, the processes for proceeding are well grounded in a relatively simple algorithm, which provides fast, sensible results, and workable outputs for additional exploratory and predictive analyses.

* At first glance Rwanda's staple food production systems appear to be more diverse than those typically found in Tanzania. However, this observation appears to be largely related to population density, as indicated by the proximity of buildings in croplands. Staple food cropping systems in proximity to buildings tend to be more complex and diverse in both Tanzania and Rwanda. This relationship appears to generalize the subsequent association rules quite well.

* Association rules can be readily incorporated into subsequent spatial machine learning and or geostatistical prediction procedures. We shall explore those possibilities in more depth with additional notebooks.

*  There are also other analysis options, such as graphical interaction models ([Højsgaard, Edwards and Lauritzen, 2012](https://link.springer.com/book/10.1007/978-1-4614-2299-0)) as well as various clustering approaches (e.g., [Schubert and Rousseeuw, 2019](https://link.springer.com/chapter/10.1007%2F978-3-030-32047-8_16)), which we could use for the modeling the data that were presented here. We have not included these in this notebook to keep things relatively concise but might explore those options in additional notebooks at a later stage.

Any questions, comments or corrections related to this notebook are most welcome via [AFSIS](mailto:mgw.africasoils.info).

# Side note: Links to staple food recipes

Of course there are some delicious recipes out there for using the staple crops indicated this notebook for meals (some of these are also quite nutritious). Interestingly, cooking advisories such as [Supercook](https://www.supercook.com/#/recipes) and [Allrecipes](https://www.allrecipes.com/search/results/?search=) are also using new recommendation algorithms to help provide meal options based on what ingredients you have available, or what you may want to have available in your fridge and dry-goods store. If you are a smallholder in East Africa, those ingredients will largely depend on what you are growing on your land and whatever your breakfast, lunch or dinner preferences are. It might be interesting and informative to do a webscrape of recipe sites to see to what degree the staple foods explored here (co)occur in African and global food recipes. We shall leave that for another day.

