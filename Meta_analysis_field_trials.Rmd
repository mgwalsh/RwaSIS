---
title: Meta-analysis of agricultual lime application effects on crop yields from field survey data
author: M.G. Walsh, R. Manners, J.V. Silva, S. Gameda and S. Aston
date: "`r format(Sys.time(), '%d, %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 2
    fig_caption: true
    css: style.css
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

# Introduction

Soil acidity affects soil nutrient availability, rhizobial and other microbial activity and is generally thought to reduce crop root growth and yield. For example, in Rwanda virtually all of the currently surveyed cropland soils are acid (pH < 7 in water) and ~64% are strongly acid (with pH < 5.5). Also see the associated notebooks about Rwanda's [Cropland soil pH](https://github.com/mgwalsh/Soils/blob/master/PSM_guide.Rmd) and its [maize & bean distributions](https://github.com/mgwalsh/RwaSIS/blob/master/RW_priority_crops.Rmd). Moreover, commonly used nitrogen fertilizers that supply ammonium directly or that react in the soil to produce ammonium, such as various ammonium nitrates, urea, manure and compost, will decrease soil pH over time (also see the advice provided by [PennState Extension](https://extension.psu.edu/soil-acidity-and-aglime)) about this. 

The application of [Agricultural lime (aglime)](https://en.wikipedia.org/wiki/Agricultural_lime) can be used to mitigate the effects of soil acidity on nutrient availability, reduced microbial activity, and the occurrence of [Aluminium](https://www.sciencedirect.com/science/article/pii/B9780128031582000011) and/or [Manganese](https://www.tandfonline.com/doi/abs/10.1080/01904169809365409) toxicities. The rocks and minerals from which agricultural lime is derived, primarily [Limestone](https://en.wikipedia.org/wiki/Limestone), but also [Chalk](https://en.wikipedia.org/wiki/Chalk), is primarily composed of calcium (CaO) and/or magnesium (MgO) oxides, which are readily measured by e.g., [X-ray fluorescence](https://en.wikipedia.org/wiki/X-ray_fluorescence). Limestone is typically pulverized and/or chemically altered to produce different aglime products of varying efficacy in increasing soil pH and crop yields. Similar to chemical fertilizers, the use of aglime also generates significant greenhouse gas emissions in its production, to-farm-gate transport and through its field application, which should be minimized on that basis.

*The main objective of this notebook is to illustrate the use of standard meta-analysis techniques for assessing the effects of aglime applications on maize and bean yields in Rwanda. Rwanda was selected for this illustration because of the high prevalence of acid soils within its croplands, as well as the availability of a relatively large, recent, multi-year, field trial dataset that is suitable for this purpose. The notebook itself is maintained on [Github](https://github.com/mgwalsh/RwaSIS/blob/master/Meta_analysis_field_trials.Rmd), and you can fork and modify it from there as you see fit.*

A [Meta-analysis (MA)](https://en.wikipedia.org/wiki/Meta-analysis) is an analytical approach that uses statistical techniques to combine the results from different studies to obtain quantitative estimates of the overall effects of particular interventions or variables on defined outcomes. Generally, the aim is to derive a pooled estimate of a common outcome variable, based on the relevant sources of variation across studies. The scope of MAs is defined by the type of population, the types of interventions (and their controls or comparators), and the types of outcomes that are of interest. The acronym PICO (population, interventions, comparators and outcomes) helps to serve as a reminder of these (e.g., see the [Cochrane Handbook](https://training.cochrane.org/handbook)). We will follow the Cochrane guidance here and will go through some of the relevant analysis steps including exploratory data analysis ([EDA](https://en.wikipedia.org/wiki/Exploratory_data_analysis)), [outlier detection](https://en.wikipedia.org/wiki/Anomaly_detection), [data modeling](https://en.wikipedia.org/wiki/Data_modeling) and interpretation.

# Data set up

To actually run this notebook, you will need to load the packages indicated in the chunk directly below to download, assemble and analyze the Rwanda lime trial data.

```{r, results = 'hide'}
# Package names
packages <- c("osfr", "dplyr", "MASS", "quantreg", "arm")

# Install packages
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Load packages
invisible(lapply(packages, library, character.only = TRUE))
```

The next chunk downloads eligibility pre-wrangled trial data from the [RwaSIS OSF repository](https://doi.org/10.17605/OSF.IO/Y9ZUT). The raw data are also openly available from [1AF](mailto:step.aston@oneacrefund.org) on email request, if you would like to trace our initial data screening and wrangling efforts.

```{r, results = 'hide'}
# Create a data folder in your current working directory
dir.create("RW_lime", showWarnings=F)
setwd("./RW_lime")
dir.create("Results")

# Trial data download from OSF at: https://osf.io/ngmjy/
osf_retrieve_file("ngmjy") %>% osf_download(conflicts = "overwrite")
lime <- read.table("RW_1AF_lime.csv", header=T, sep=",")
```

The below is the structure of the resulting dataframe that we shall be using. The only variable, which has not been properly cleaned yet in these data is the crop variety indicator (`crop_var`). We will not be using that in this notebook. However, we have included it for reference and any potential updates in future versions of this notebook (e.g., see [Jaleta et al., 2020](https://doi.org/10.1371/journal.pone.0235484) as to why this might be important).

```{r, echo = FALSE}
str(lime)
```

# Population, interventions, comparators and outcome (PICO)

The data we will be using in this notebook were generated by the [One Acre Fund (1AF)](https://oneacrefund.org/). Two separate field studies were conducted by 1AF as part of their soil acidity management intervention testing and monitoring activities in Rwanda during 2016-2017 and 2019-2020. They consist of 2,166 individual (multi-location, on-farm) trials with n = 10,464 crop yield (kg ha^-1^) measurements × `crop` × `lime` × `fert` treatments, to assess the effects of aglime applications on crop yields against the relevant control yields i.e., those without a lime application. The 2 studies were conducted in 20 Level-4 administrative units (or so-called "Cells" in Rwanda), two of which overlap temporally by `study`. Crop yield measurements were generally repeated over at least 2 cropping seasons in each study, defined by the relevant `trial_age` × `cell` × `crop` × `lime` × `fert` treatment combinations. Note that this combination also defines the main **PICO** definitions that are analyzed here.

## PICO Tables

It is common practice in meta-analysis that the first table of e.g., a [Cochrane review article](https://www.cochranelibrary.com/), often referred to as “Table 1”, summarizes the descriptive statistics of the characteristics of the study populations that are stratified by the main individual treatment / comparator variables. The [`aggregate`](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/aggregate) function in the R [`stats`](https://www.rdocumentation.org/packages/stats/versions/3.6.2) package is convenient in this context. We use it here to summarize both the fixed treatment (`trial_age` × `crop` × `lime` × `fert`) and the associated random effects (`trial_age` × `cell`) that would go into data model specifications. The following chunks generate the associated example crop yield quantile tables.

```{r}
# main fixed PICO effects on yields (kg / ha)
fix <- aggregate(lime$yield, list(lime$trial_age, lime$lime, lime$fert, lime$crop), 
                 FUN = quantile, probs = c(0.025, 0.5, 0.975))
colnames(fix) <- c("trial_age", "lime", "fert", "crop", "Q")
fix
```

```{r}
# random effects on yields (kg / ha)
ran <- aggregate(lime$yield, list(lime$trial_age, lime$cell), FUN = quantile, probs = c(0.025, 0.5, 0.975))
colnames(ran) <- c("trial_age", "cell", "Q")
ran
```

## Outlier screening

The PICO tables (above) show crop yield outliers (e.g., see the Bihembe cell above) that should be examined, flagged and potentially screened before proceeding to any data modeling and/or machine learning steps. There are also quite a few zero yields, which may be due to censoring, lack of follow-up and/or local crop failures. However, the causes of these are not discernible from the data. There are also substantial trial drop-outs in the follow-up years (of 2017 & 2020, i.e., at `trial_age = 1`), in both studies based on ... 

```{r}
age <- aggregate(lime$yield, list(lime$trial_age, lime$study), FUN = length)
colnames(age) <- c("trial_age", "study", "n")
age
```

Because of the lack of georeferencing of the individual trials it is not possible to tell which individual trials dropped-out during the second year in each study. Also, new trials may have come into the studies during the follow-up period that were not recorded as such. While the fairly large proportion of dropouts is somewhat concerning, we have no way of telling precisely where or how they may have occurred in these multi-year studies. 

Zeros and extreme values in the recorded data are much more readily identified. The simplest and shortest way of doing this is to consider the yield percentiles by the main fixed PICO factors. We can examine these with [quantile regression](https://mran.microsoft.com/snapshot/2018-04-30/web/packages/quantreg/quantreg.pdf) as follows in the next chunk. Based on the results, we can subsequently decide which (if any) of the extreme values to screen from further analyses.

```{r}
# First remove the zeros ... they are not useful in this context
lime <- lime[which(lime$yield > 0), ]

# Then fit the quantile regressions
out.rq <- rq(yield ~ factor(trial_age) + factor(crop) + factor(lime) * factor(fert), tau = c(0.025, 0.975),
            data = lime)
out.val <- as.data.frame(predict(out.rq, lime))
colnames(out.val) <- c("lo", "hi") 
out.rq
```

```{r}
# You can always cbind the out.val predictions for further processing with e.g., ...
lime <- cbind(lime, out.val)

# Which is useful for outlier screening with e.g., <dplyr>
lime <- lime %>% mutate(out = case_when(yield < lo | yield > hi ~ 'y', TRUE ~ 'n'))

# Write the data out to your Results directory
write.csv(lime, "./RW_lime/Results/RW_lime_trials.csv", row.names = FALSE)

table(lime$out)
```

The table above shows that ~5% of the crop yield measurements at its distributional (low and high) tail ends were flagged as extreme values ... which is what we were going for in this exploratory example. You can always adjust the percentile values in the `out.rq` regressions above. Another convenient thing about this approach is that you could also use additional PICO and/or other factors in those regressions for more comprehensive extreme value explorations. We shall leave those for you to test.

# Multilevel regressions

Many surveys, such as this one, will have difficulties in obtaining representative samples of individual trials across geographical areas of interest. However, with proper statistical adjustment, non-representative surveys can be used to generate and monitor crop yields more accurately. While we cannot build response models for individual trials because those were not identified (georeferenced) or tracked over time in these studies, we will run some initial multilevel models grouped by `cell` and `trial_age` using the [`lme4`](https://cran.r-project.org/web//packages/lme4/lme4.pdf) package on the main PICO variables for the 2 studies. The following chunk provides some informative examples.

```{r}
# We will use the outlier removed data here
lime <- lime[which(lime$out == 'n'), ]

m0 <- lmer(log(yield) ~ factor(trial_age) + factor(crop) * factor(lime) * factor(fert) + (1|study),
           data = lime)

m1 <- lmer(log(yield) ~ factor(trial_age) + factor(crop) * factor(lime) * factor(fert) + (1|study) +
          (1|cell:trial_age) + (1|cell:crop), data = lime)

m2 <- lmer(log(yield) ~ factor(trial_age) + factor(crop) * factor(lime) * factor(fert) + (1|study) +
          (1|cell:trial_age) + (1|cell:crop) + (1|cell:lime) + (1|cell:fert), data = lime)

anova(m0, m1, m2)
```

Model `m1` is clearly preferable to the overly simple `m0` model based on the respective AIC, BIC and logLik comparisons in the model `anova`. The `m2` model, provides a slightly better fit to the data than `m1`. However, the choice between the `m1` and `m2` models appear to be a matter of preference. Because of the overall meta-analysis study design and for reasons of parsimony, we prefer model `m1`. The estimated [Production function](https://en.wikipedia.org/wiki/Production_function) coefficients for the `m1` model are shown directly below.   

```{r, echo = FALSE}
display(m1)
```

Other multilevel model specifications and analyses (e.g., see [Multilevel regression case studies](https://bookdown.org/jl5522/MRP-case-studies/)) in this context are certainly possible e.g., by also including variables such as crop varieties and genotype × environment interactions ([GE](https://en.wikipedia.org/wiki/Gene%E2%80%93environment_interaction)), seasonality, spot vs broadcast application, etc. But, the data would need to be collected and assembled to better reflect specific treatment differences and very importantly the spatial variation in crop yields for these more contingent factors to make any measurable differences in the yield outcome variable that is considered here. 

# Main case-study conclusion and takeaways

*Based on the two recent crop yield studies that were analyzed here, we currently would not be able to justify nor recommend investments in wide-spread aglime applications in the maize and bean cropping systems of Rwanda. The data, though extensive, practical and very useful, were insufficient to warrant those types of interventions at a national scale, for either maize or bean crops.*

The main takeaways of this notebook are the following:

* In the two studies presented the application of lime showed only modest positive effects on either bean or maize crop yields that were observed over a two year period vis-à-vis their respective control yields.

* The simple question: "By how much do aglime applications improve maize and bean crop yields on the acid soils in Rwanda?", cannot be satisfactorily answered in this notebook. At present we can only infer that there were quite modest yield improvements in some of the surveyed cells (administrative units). What we do not know is if these local improvements warrant the associated lime application costs to farmers, in those places, over the long-term.

* The associated analyses run fast (< 1 min) on a normal, 8 core, 16 GB memory computer and could be further automated for the purpose of EDAs, outlier screening, monitoring and data modeling as additional and/or new survey and trial data become available in Rwanda or elsewhere. 

Any questions, comments or corrections related to this notebook are most welcome via [AFSIS](mailto:mgw.africasoils.info).

# Addendum: Recommended field trial protocol adjustments

* Put all raw survey and experiment data on KoBoToolbox. Just go to [KoBoToolbox](https://www.kobotoolbox.org/), set up the forms in Excel (or anything else) and deploy the forms for your surveys and experiments using [ODK](https://opendatakit.org/) ... both are free and easy to use! Then systematically georeference, time stamp, and photograph all individual field trials and survey locations. 

* East Africa is certainly not Nebraska or Brazil. Intercropping with local varieties occurs virtually everywhere in Rwanda's smallholder production systems and elsewhere in East Africa. Our recommendation is to start conducting agricultural input trials in ways that actually reflect those facts rather than on the basis of monocropping practices.

* Repeat soil acidity (pH & exchangeable acidity) measurements over time. You don't really need a spectrometer to do that, though it might help ... also with other related soil properties. [pH probes](https://www.amazon.com/ph-probe/s?k=ph+probe) sell for ~50 U$ on Amazon.

* Systematically document the crop varieties that are used in trials. This would help in assessing genotype × environment interactions ([GE](https://en.wikipedia.org/wiki/Gene%E2%80%93environment_interaction)) that plant breeders need to assess, recommend, and develop acid tolerant crop varieties in different places. 

* Specify lime provenance data (see e.g., [Rwanda aglime sources](https://ruforum.org/sites/default/files/Sirikare%20et%20al.pdf)). Aglime sources in Rwanda and elsewhere are quite variable in terms of their calcium carbonate equivalents (CCE), Ca/Mg ratios and estimated extractable limestone source reserves.

* Generate more efficient agronomic response trial designs. Field trials can be a quite expensive operational undertaking. Therefore, the quality of the recorded data is also an important consideration ... also sometimes less is more this context. We encourage you to explore leaner, more optimized (e.g., d-optimized, latin-hypercube, or other) trial designs than the ones that were used to generate the data here. This would save money and may improve data quality.

* Put all of the data and analysis code on Github and/or OSF ... unless there are actual [IRB](https://www.fda.gov/regulatory-information/search-fda-guidance-documents/institutional-review-boards-frequently-asked-questions) and/or privacy concerns! Make the data and the code truly [FAIR](https://en.wikipedia.org/wiki/FAIR_data) so that others can attempt to help you more easily!
