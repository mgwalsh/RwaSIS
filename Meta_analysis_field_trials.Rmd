---
title: Meta-analyses of agricultural lime application effects on crop yields from field trial data
author: M.G. Walsh, R. Manners, J.V. Silva, S. Gameda and S. Aston
date: "Last updated on: `r format(Sys.time(), '%d, %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 1
    fig_caption: true
    css: style1.css
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

# Introduction

Soil acidity affects soil nutrient availability, rhizobial and other microbial activity and is generally thought to reduce crop root growth and yield. For example, in Rwanda virtually all of the currently surveyed cropland soils are acid (pH < 7 in water) and ~64% are strongly acid (with pH < 5.5). Also see the associated notebooks about Rwanda's [Rwanda cropland soil pH](https://github.com/mgwalsh/Soils/blob/master/PSM_guide.Rmd) and its [maize & bean distributions](https://github.com/mgwalsh/RwaSIS/blob/master/RW_priority_crops.Rmd). Moreover, commonly used nitrogen fertilizers that supply ammonium directly or that react in the soil to produce ammonium, such as various ammonium nitrates, urea, manure and compost, will decrease soil pH over time (also consult the advice provided by e.g., [PennState Extension](https://extension.psu.edu/soil-acidity-and-aglime) about this).

The application of [Agricultural lime (aglime)](https://en.wikipedia.org/wiki/Agricultural_lime) can be used to mitigate the effects of soil acidity on nutrient availability, reduced microbial activity, and the occurrence of [Aluminium](https://www.sciencedirect.com/science/article/pii/B9780128031582000011) and/or [Manganese](https://www.tandfonline.com/doi/abs/10.1080/01904169809365409) toxicities. The rocks and minerals from which agricultural lime is derived, primarily [Limestone](https://en.wikipedia.org/wiki/Limestone), but also [Chalk](https://en.wikipedia.org/wiki/Chalk), is primarily composed of calcium (CaO) and/or magnesium (MgO) oxides, which are readily measured by e.g., [X-ray fluorescence](https://en.wikipedia.org/wiki/X-ray_fluorescence). Limestone is typically pulverized and/or chemically altered to produce different aglime products of varying efficacy in increasing soil pH and crop yields. Similar to chemical fertilizers, the use of aglime also generates significant greenhouse gas emissions in its production, to-farm-gate transport and through its field application, which should be minimized.

A [Meta-analysis](https://en.wikipedia.org/wiki/Meta-analysis) is an analytical approach that uses statistical techniques to combine the results from different studies to obtain quantitative estimates of the overall effects of particular interventions on defined outcomes. Generally, the aim is to derive estimates of a common outcome variable, based on the relevant sources of variation across studies. The scope of meta-analyses is defined by the type of population, the types of interventions, their comparators, and the types of outcomes that are of interest. The acronym PICO (population, interventions, comparators and outcomes) helps to serve as a reminder of these (e.g., see the [Cochrane Handbook](https://training.cochrane.org/handbook)). We will follow the Cochrane guidance here and will go through some of the relevant analysis steps including data setup, [exploratory data analysis](https://en.wikipedia.org/wiki/Exploratory_data_analysis), [data modeling](https://en.wikipedia.org/wiki/Data_modeling) and model interpretation. 

The main question that is posed here is: **"By how much could crop yields be increased with aglime applications?"** The relevant PICO eligibility definitions for addressing this question are:

* P - on-farm food crop yield trials conducted (in Rwanda, or elsewhere)
* I - aglime application + recommended fertilizer application
* C - recommended fertilizer application only (the current best practice)
* O - effects on maize and bean yields

Rwanda was selected for this illustration because of the high prevalence of strongly acid soils within its croplands, as well as the availability of a relatively large, recent, multi-season, on-farm trial dataset that is suitable for this purpose.

# Data set up

To actually run this notebook, you will need to load the packages indicated in the chunk directly below to download, assemble and analyze the lime trial data that are used in this workflow.

```{r, results = 'hide'}
# Package names
packages <- c("osfr", "dplyr", "stringi", "quantreg", "DT", "metafor", "metaviz")

# Install packages
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Load packages
invisible(lapply(packages, library, character.only = TRUE))
```

The next chunk downloads trial data from the [RwaSIS OSF repository](https://doi.org/10.17605/OSF.IO/Y9ZUT). The raw data are also openly available from [One Acre Fund (OAF)](mailto:step.aston@oneacrefund.org) on email request, if you would like to trace our initial data eligibility screening and wrangling efforts.

```{r, results = 'hide'}
# Create a data folder in your current working directory
dir.create("RW_lime", showWarnings=F)
setwd("./RW_lime")
dir.create("Results")

# Trial data download from OSF at: https://osf.io/7mt6k/
osf_retrieve_file("7mt6k") %>% osf_download(conflicts = "overwrite")
lime <- read.table("1AF_lime.csv", header=T, sep=",")
lime$season <- paste(lime$year, lime$season, sep="")
lime$site <- stri_trans_totitle(lime$site) 
```

```{r, echo = FALSE}
str(lime)
```

# PICO eligibility

The data we will be using in this notebook were generated by the [One Acre Fund (OAF)](https://oneacrefund.org/) in Rwanda, Kenya and Tanzania as part of their intervention testing and M&E program. They consist of `r length(unique(lime$tid))` individual (multi-location, on-farm) trials with `r length(lime$yield)` crop yield (kg ha^-1^) measurements in various `crop` × `lime` × `fertilizer` treatment combinations. The trials were conducted in `r length(unique(lime$site))`, Level-4 administrative units over `r length(unique(lime$season))` cropping seasons between 2014-2020. Note that the collective label `crop=="bean"`refers to [Phaseolus vulgaris L.](https://en.wikipedia.org/wiki/Phaseolus_vulgaris) including the "common", "climbing" or "bush" bean cultivars that were used in the trials. We shall only be focusing on an [A/B comparison](https://en.wikipedia.org/wiki/Randomized_controlled_trial) between lime treated (`lime=="y" & fert=="y"`) and the corresponding comparator yields (`lime=="n" & fert=="y"`) that were recommended locally by OAF field extension staff. The next chunk calculates the outcomes (`delta`) for the lime intervention and the corresponding comparator yields.

```{r}
trt <- subset(lime, lime=="y" & fert=="y", select=c(country, season, site, year, tid, crop, cce_amt, yield))
con <- subset(lime, lime=="n" & fert=="y", select=c(tid, yield))
trial <- merge(trt, con, by="tid")
colnames(trial) <- c("trial_id","country", "season", "site","year","crop","lime_amt",
                     "treated_yield","control_yield")
trial$delta <- trial$treated_yield - trial$control_yield
```

```{r, echo = FALSE, results = 'hide'}
rwa <- subset(trial, country=="RWA", select=c(trial_id, control_yield, treated_yield, delta))
rqd <- rq(I(treated_yield/1000)~I(control_yield/1000), tau=c(0.025,0.5,0.975), data=rwa)
rqd
```

We can plot the `delta` values out to obtain a feel for the distribution of the aglime yield effect comparisons for the `r length(unique(rwa$trial_id))` OAF aglime trials that we consider to be eligible under our PICO definition for Rwanda.

```{r, fig.align = 'center', fig.show='hold', out.width="50%", fig.cap = "**Figure 1:** Plots showing the relationships between aglime intervention and fertilizer only comparator crop yields for PICO eligible liming trials conducted in Rwanda."}

par(pty="s", mar=c(4,4,1,1))
plot(I(treated_yield/1000)~I(control_yield/1000), rwa, xlim = c(0,15), ylim = c(0,15),
     xlab = "Fertilizer only yield (t/ha)", ylab = "Aglime intervention yield (t/ha)", cex.lab = 1.3)

abline(c(0,1), col="grey", lwd = 2)
curve(rqd$coefficients[2]*x+rqd$coefficients[1], add=T, from=0, to=15, col="dodger blue", lwd=2)
curve(rqd$coefficients[4]*x+rqd$coefficients[3], add=T, from=0, to=15, col="red", lwd=2)
curve(rqd$coefficients[6]*x+rqd$coefficients[5], add=T, from=0, to=15, col="dodger blue", lwd=2)

plot(ecdf(rwa$delta/1000), main="", xlab="Aglime yield effect (t/ha)", ylab="ECDF", xlim=c(-6,6),
     verticals=T, lty=1, lwd=2, cex.lab=1.3, col="tomato", do.points=F)
abline(0.5,0, lty=1, col="grey")
```

Note that Figure 1 does not show a substantial aglime intervention effect. To explore this comparison further, we aggregate the `delta` yield values by `season`, `site` and `crop` type to set up a PICO table for meta-analyses. Also note that this could be done in a number of different ways that could include additional moderator variables and/or grouping factors.

```{r}
lm <- aggregate(trial$lime_amt, list(trial$country, trial$season, trial$site, trial$crop), FUN = mean)
pn <- aggregate(trial$delta, list(trial$country, trial$season, trial$site, trial$crop), FUN = length)
pm <- aggregate(trial$delta, list(trial$country, trial$season, trial$site, trial$crop), FUN = mean)
ps <- aggregate(trial$delta, list(trial$country, trial$season, trial$site, trial$crop), FUN = sd)

pico <- cbind(pn, round(lm[,5], digits = 0), round(pm[,5], digits = 0), round(ps[,5], digits = 0))
colnames(pico) <- c("country","season","site","crop","n","lime","yi","vi")
pico$vi <- (pico$vi / sqrt(pico$n))^2
pico$vi <- round(pico$vi, digits = 0)
pico$lime <- round(pico$lime/1000, digits = 2)
pico <- pico[order(pico$country, pico$site), ]

datatable(pico, rownames = FALSE, select = "multiple")
```

**PICO table legend**

* `country` - ISO country code (KEN, RWA or TZA)
* `season` - year and season (a or b) 
* `site` - Site name (22 sites in Rwanda, 42 sites in total including Kenya and Tanzania)
* `crop` - Crop type (maize or beans)
* `n` - total number of trials per `season`, `site` & `crop` type
* `lime` - average lime application rates (t ha^-1^ CCE) per `season`, `site`, & `crop` type
* `yi` - mean yield response (treated - control, in kg ha^-1^) per `season`, `site` & `crop` type
* `vi` - variance of yield response (SE^2^ of the mean yield response) per `season`, `site` & `crop` type

# Meta-analyses

We shall use the [`metafor`](http://www.metafor-project.org/doku.php) package in this section, which provides a robust and widely-tested approach for fitting random-effects and meta-regression models (see [Viechtbauer, 2010](https://doi.org/10.18637/jss.v036.i03), which describes the functionality of the package). You may also want to watch the excellent, recent tutorial by [Wolfgang Viechtbauer](https://www.youtube.com/watch?v=IkduL5iRdqo) for additional inspiration about meta-analyses. 

The next chunks fit initial random effects models to the Rwanda trial data, followed the simplest (least formatted or annotated) summary forest plots for those models. There are a lot of options in this context (see the customization guidance provided on the [`metafor`](http://www.metafor-project.org/doku.php) website about this), but we will leave those for you to explore.

```{r}
# Rwanda maize random-effects model
rm0 <- rma(yi, vi, subset=(country=="RWA" & crop=="maize"), data = pico)

# Rwanda beans random-effects model
rb0 <- rma(yi, vi, subset=(country=="RWA" & crop=="beans"), data = pico)
```

```{r, echo = FALSE, results = 'hide'}
# look at the results ... I^2^  and other heterogeneity estimates are high 
rm0
rb0
```

```{r, fig.align = 'center', fig.show='hold', fig.height = 8, fig.cap = "**Figure 2:** Forest plots showing the mean difference maize (top) and bean (bottom) yields in response to lime treatments in Rwanda based on random effects models. Note that the dashed line around the RE model polygon (diamond) at the bottom of each plot indicates the 95% prediction interval for the combined outcomes, which in both cases includes 0."}

labs <- paste(pico$country, pico$season, pico$site, pico$crop, sep = ", ")
op <- par(cex=0.9, font=4)
par(mar=c(4,4,1,1))

# Maize
forest(rm0, slab = labs, header="Country, Season, Site, Crop", 
       xlab = "Maize yield effect (kg/ha)", digits = 0, addpred=TRUE)

# Beans
forest(rb0, slab = labs, header="Country, Season, Site, Crop", 
       xlab = "Bean yield effect (kg/ha)", digits = 0, addpred=TRUE)
```

We can also look at the moderator effects of the average liming rates (t/ha) that were applied at the different sites across the Rwanda trials with mixed-effects models.

```{r, echo = FALSE, results = 'hide'}
# individual maize and bean mixed effects models
rm1 <- rma(yi, vi, mods = ~ lime, subset=(country=="RWA" & crop=="maize"),  data = pico, digits = 1)
rb1 <- rma(yi, vi, mods = ~ lime, subset=(country=="RWA" & crop=="beans"),  data = pico, digits = 1)
```

```{r}
# combined model with lime application rate effect estimates 
ry1 <- rma(yi, vi, mods = ~ factor(crop)+lime, subset=(country=="RWA"),  data = pico, digits = 1)
ry1
```

Below is an example of a bubble plot showing the observed yield differences of the individual trial sites plotted against a quantitative moderator variable i.e., in this case the average lime application rate yield effects that are grouped by `season`, `site` and `crop` type in Rwanda. The size of the points is proportional to the precision (inverse variance) weights that individual studies received in the analysis, with larger points receiving more weight. Based on the mixed-effects meta-regression models above, the predicted average yield response as a function of the lime application rate is also shown in the plot, with the corresponding 95% confidence interval. Note the heterogeneity between trials that received between 1 - 1.5 (t ha^-1^ CCE) lime applications.

```{r, echo = FALSE, fig.align = 'center', fig.show='hold', out.width="75%", fig.cap = "**Figure 3:** Lime application rate effects on mean yield differences in Rwanda based on a site-level mixed-effects model."}

par(pty="s", mar=c(4,4,1,1))
regplot(ry1, mod = "lime", xlim=c(0.5,2.5), predlim=c(0.5,2.5), 
        xlab="Lime application rate (t/ha)",
        ylab="Mean yield difference (kg/ha)", digits = 0, las=1, bty="l",
        cex.lab=1.2, cex.axis=0.85, refline=0)
```

```{r, echo = FALSE, results = 'hide'}
ry2 <- rma.mv(yi, vi, mods = ~ factor(crop)+lime, random = ~ 1|season/site, subset=(country=="RWA"), 
           data = pico, digits = 1)
ry2
```

# Main conclusion and takeaways

*Based  on the presented analyses, we currently do not recommend investments in wide-spread aglime applications in the maize and bean cropping systems of Rwanda. The data, though extensive, practical and very useful, are insufficient to justify recommending that these types of interventions should be applied at a national scale for either maize or bean crops. More spatially targeted lime applications may prove useful in the future, but we could not demonstrate a sufficiently large yield effect-size based on the currently available data. If you are going to do such presumeably expensive trials, you should try to think them through to do them right.*

**The main takeaways from this notebook are the following:**

* In the OAF trials presented, the application of lime showed only small positive intervention effects on crop yields (~350 kg ha^-1^ per metric ton ha^-1^ of lime added), which were observed over `r length(unique(pico$season))` cropping seasons relative to their respective comparator yields. The fairly low average lime application rates (see Figure 2) in these trials may not have been sufficient to overcome the exchangeable (reserve) acidity constraints nor to effectively alter soil pH. However, testing for specific lime dose-response relationships would require additional and more systematically collected intervention and comparator data. See the additional guidance about soil spectral test based [liming recommendations](https://osf.io/2v46w/) at this link. Just download the html file to display it in your browser.

* This study had several limitations. First, there was substantial methodological heterogeneity among selected field trials in terms of the lime intervention characteristics in terms of lime dosage, application methods and followup times. Additional sources of heterogeneity included differences in statistical heterogeneity among sites, which was high for the crop yield outcomes for maize and beans. Therefore, we could only assess the effectiveness of the lime application treatments as a whole.

* As is demonstrated, site-level varying effects are likely to dominate production function estimates and inference. These warrant more systematic investigations. The heterogeneity of the trials that were reported here is high (I^2^ > 80%, e.g., see `model ry1` results and Figures 2 & 3), indicating that additional subgroup and/or moderator analyses are/would be needed to more consistently differentiate between both interventions and comparators in the underlying trial designs. One initial way of correcting for that uncertainty would be to include the georeference of each individual on-farm trial. Amendments to and reanalyses of the data that are presented here could subsequently be accomplished quickly. This would also assist in developing spatially explicit models for lime responses in the future.

* The simple initial question that was posed: *"By how much could crop yields be increased with aglime applications?"*, can be answered using the approach and workflow that was used in this notebook. Additional crops, lime application treatments and georeferenced trials could be readily amended to the PICO framework and the associated analyses that were presented here.

* The workflow runs fast (< 2 min) on a normal, 8 core, 16 GB memory computer and could be further automated for the purpose of EDAs, outlier screening, monitoring and data modeling as additional and/or new trial data become available in Rwanda or elsewhere. We will post additional material for calculating full [Bayesian posterior predictions](https://www.bayesrulesbook.com/chapter-8.html) in a future notebook. These take much longer to run.

# Addendum: Recommended field trial protocol adjustments

* Should you be interested in more than unreplicated case studies, ensure that individual experimental designs can actually be harmonized for more efficient and reliable learning. This bears careful thinking about the relevant PICO factors prior to initiating any additional liming projects or trials. It is generally best to simulate the data before initiating activities on the ground. The workflow presented here generates the needed prior information for such a process.

* Once those factors have been thought through, more efficient and less costly agronomic response trial designs could be generated for future deployment. Conducting field trials is a quite expensive operational undertaking, where the quality of the recorded data is also an important consideration. Sometimes less is more this context. We encourage you to explore leaner, more optimized (e.g., d-optimized, latin-hypercube, or other) trial designs than the ones that were used to generate the data that were used here. This would save money, improve data quality, and might also improve statistical inference and learning.

* Put all raw survey and experimental designs on KoBoToolbox. Just go to [KoBoToolbox](https://www.kobotoolbox.org/), set up the forms in Excel (or anything else) and deploy the forms for your surveys and experiments using [ODK](https://opendatakit.org/) ... both are free and easy to use! Then systematically georeference, time stamp, photograph and monitor all individual field trials and/or survey locations. 

* East Africa is certainly not Nebraska, South Africa or Brazil. *Polycropping* or *intercropping* with local staple food varieties occurs virtually everywhere in Rwanda's smallholder production cropping systems and elsewhere in East Africa (see: [Mixed Farming Systems](https://osf.io/7rt6c/)). Our recommendation is to start conducting agricultural input trials in ways that actually reflect those facts rather than on the basis of largely unrealistic *monocropping* practices.

* Repeat soil acidity (pH & exchangeable acidity) measurements over time. You don't really need spectrometers to do that, though it might help ... also with other related soil properties. Good [pH probes](https://www.amazon.com/ph-probe/s?k=ph+probe) sell for ~50 U$ on Amazon.

* Systematically document the crop varieties that are used in trials. This would help in assessing additional genotype × environment interactions ([GE](https://en.wikipedia.org/wiki/Gene%E2%80%93environment_interaction)) that plant breeders need to assess, recommend, and develop acid tolerant crop varieties in different places. 

* Consistently specify lime provenance data. Aglime sources in Rwanda (e.g., see [Sirikare et. al., 2012](https://ruforum.org/sites/default/files/Sirikare%20et%20al.pdf)) and elsewhere are quite variable in terms of their calcium carbonate equivalents (CCE), Ca/Mg ratios, fineness and estimated extractable limestone source reserves (also see [Nduwumuremyi et al., 2013](https://doi.org/10.5897/JSSEM2013.0386)).

* Put all of the data and analysis code on Github and/or OSF ... unless there are actual [IRB](https://www.fda.gov/regulatory-information/search-fda-guidance-documents/institutional-review-boards-frequently-asked-questions) and/or privacy concerns. Make the data and the code truly [FAIR](https://en.wikipedia.org/wiki/FAIR_data) so that others can attempt to help more easily!

Any questions, comments or corrections related to this notebook are most welcome via [AFSIS](mailto:mgw.africasoils.info). The notebook is maintained on [Github](https://github.com/mgwalsh/RwaSIS/blob/master/Meta_analysis_field_trials.Rmd), and you can fork and modify it from there as you see fit.
