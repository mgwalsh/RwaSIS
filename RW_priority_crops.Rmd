---
title: Crop distribution survey meta-analyses and small area estimation 
author: M.G. Walsh, R. Manners, ...
date: "`r format(Sys.time(), '%d, %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 1
    fig_caption: true
    css: style.css
---

```{r, echo=FALSE}
knitr::opts_chunk$set(message = FALSE)
```

# Introduction

The main intent of this notebook is to illustrate starter code for predictive crop type and cropping systems distribution mapping and the associated statistical small area estimates [SAE](https://www.census.gov/srd/csrm/SmallArea.html), which define the crop and cropping systems types in a given region of interest ([ROI](https://en.wikipedia.org/wiki/Region_of_interest)). We use both Rwanda's most recent and some of its legacy cropland survey (label) data here and the associated gridded raster (features) to illustrate the general approach and the main data analysis steps. Rwanda, being a small country, is convenient for this illustration because the script will run fast so as to not test your patience in running it. The notebook is publicly maintained on [Github](https://github.com/mgwalsh/RwaSIS/blob/master/RW_priority_crops.Rmd), and you can fork and modify it from there as you see fit. You may also want to take a look at the [GeoSurvey cropland area notebook](https://osf.io/shkxp/), which describes some of the spatial prediction methods and the associated SAE procedures in more detail.

# General data setup

To actually run this notebook, you will need to load the packages indicated in the chunk directly below. This allows you to assemble Rwanda-wide observations, link those to the spatial data and then model them using machine learning. 

```{r}
# Package names
packages <- c("downloader", "jsonlite", "rgdal", "sp", "raster", "leaflet", "DT", "htmlwidgets", "devtools", "caret", "caretEnsemble", "mgcv", "MASS", "randomForest", "xgboost", "nnet", "dplyr", "doParallel", "dismo", "arm")

# Install packages
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
    install.packages(packages[!installed_packages])
}

# Load packages
invisible(lapply(packages, library, character.only = TRUE))
```

## Data downloads

The following chunk downloads the data that we have assembled, which are needed for running this particular example. Specifically, it assembles georeferenced field observations of priority crops that have been requested by [RAB](http://rab.gov.rw/index.php?id=180), Maize, Wheat, Rice, Potato, Cassava and Bean, for their planned management response trials and links these to remote sensing images and GIS data represented by the `grids` feature stack. We focus on predicting the distribution of Maize here, but the approach is equally applicable to any given [georeferenced](https://en.wikipedia.org/wiki/Georeferencing) crop type under consideration. Note that this chunk is Mac or Linux specific and so the directory structures should be changed to run on Windows machines.

```{r}
# Create a data folder in  your current working directory
dir.create("Priority_crops", showWarnings=F)
setwd("./Priority_crops")
dir.create("Results", showWarnings=F)

# Download crop data
download("https://osf.io/zqh9y/?raw=1", "priority_crops.csv.zip", mode = "wb")
unzip("priority_crops.csv.zip", overwrite = T)
crop <- read.table("priority_crops.csv", header = T, sep = ",")

# Download GADM-L5 shapefile (courtesy of: http://www.gadm.org)
download("https://www.dropbox.com/s/fhusrzswk599crn/RWA_level5.zip?raw=1", "RWA_level5.zip", mode = "wb")
unzip("RWA_level5.zip", overwrite = T)
shape <- shapefile("gadm36_RWA_5.shp")

# Download raster stacks
download("https://osf.io/hp6v7?raw=1", "RW_250m_2020.zip", mode = "wb")
unzip("RW_250m_2020.zip", overwrite = T)
download("https://osf.io/u73pd?raw=1", "RW_GS_preds.zip", mode = "wb")
unzip("RW_GS_preds.zip", overwrite = T)
glist <- list.files(pattern="tif", full.names = T)
grids <- stack(glist)

# Download cropland mask
download("https://osf.io/bmysp/", "RW_CP_mask.zip", mode = "wb")
exdir <- "./Mask" 
unzip("RW_CP_mask.zip", exdir = exdir, overwrite = T)
```

## Priority crop occurrence data

RAB's 6 priority crop occurrence observations (presence/absence) for Rwanda were assembled from 4 georeferenced surveys:

1. The currently ongoing RwaSIS survey designated as `base` (see and download the raw data at: [Kobo](https://kobo.humanitarianresponse.info/#/forms/a3jwzkBTtDvdaZJgR6YjAe/summary)). There are currently 1,126 observations in this survey in which at least one of the priority crops is present. Note that this number will change during 2021/22 as the RwaSIS crop and soil surveys progress, and we will update the numbers accordingly. Also note that to the best of our knowledge these are the only crop distribution and soil data that are being collected using a spatially balanced sampling frame (see the notebook about this at: [Cropland sample notebook](https://osf.io/wn3my)). 

2. The [CIALCA Farm Heterogeneity Survey of Rwanda](https://cialca.shinyapps.io/cialca_base_2files/) survey desinated as `s1`. There are 2,483 georeferenced observations in this survey in which at least one of the priority crops is present. Note that the spatial coordinates for this survey are slightly offset to the GPS locations of the households rather than the locations of actual fields.

3. The [CNLS](https://cropnuts.com/) soil survey of Rwanda's croplands, designated as `s2`, which is openly accessible at: [OSF](https://osf.io/shvpd/). There are 602 observations in this survey where at least one of the priority crops was present. We extracted these from the crop type descriptions from the soil survey's meta-data.

4. The [RAB](http://rab.gov.rw/index.php?id=180) soil survey of lowland rice areas of Rwanda, designated as `s3`. There are 916 observations in this survey for sites where only rice was present, by design. Note that this is an [oversample](https://en.wikipedia.org/wiki/Oversampling_and_undersampling_in_data_analysis) of the rice growing area of Rwanda and should to be treated as such for the purpose of some of the SAE analyses below. It is however very useful for mapping similar areas accross Rwanda, which is precisely why it is included here. 

## Gridded data

The pre-processed Rwanda grid data (in the `grids` raster stack) were derived and reprojected from their primary open sources. You can also download the entire stack directly at [RwaSIS grids](https://osf.io/hp6v7/). The short descriptions of the included rasters, and their sources are provided in the table immediately below.

\
```{r, echo=FALSE, results='asis'}
download("https://osf.io/e2x4s?raw=1", "./Priority_crops/Grid variables.csv", mode = "wb")
vars <- read.table("./Priority_crops/Grid variables.csv", header = T, sep = ",")
datatable(vars)
```
\
These Rwanda-wide (actually Africa-wide) features will change over time and I will update them if and when needed. Also note that these are grouped by factor variables that designate the occurrence of a given crop as a [Jenny-type](https://soilandhealth.org/wp-content/uploads/01aglibrary/010159.Jenny.pdf) function *f*(crop) ~ (*a, c, o, r, s*) where:

* a - anthropic variables
* c - climatic variables
* o - organismal and successional variables
* r - relief / topographical variables
* s - parent material and soil related variables

The main notion here is that the occurrence and distribution of croplands and crop types must always be associated with the distribution of humans and their built infrastructure, but also constrained or facilitated by changes in typically much slower environmental factors such as climate, [ecological succession](https://en.wikipedia.org/wiki/Ecological_succession), topography, parent materials and soils. Note that all of these change and interact over space-time and should be, but are currently not adequately monitored across Africa.

## Combined Rwanda crop occurrence survey dataframe

This next chunk reprojects the priority data to the [Lambert Azimuthal Equal Area (LAEA)](https://en.wikipedia.org/wiki/Lambert_azimuthal_equal-area_projection) grid of the AfSIS raster variables and then writes out the combined dataframe `RW_priority_crop_dist.csv` into your `./Priority_crops/Results` directory, if you'd like to process those outputs in software other than R. It also generates a location map of where in Rwanda those 5.1k+ crop survey observations were obtained.

```{r}
# Attach GADM-L5 administrative unit names from shape
coordinates(crop) <- ~lon+lat
projection(crop) <- projection(shape)
gadm <- crop %over% shape
crop <- as.data.frame(crop)
crop <- cbind(gadm[ ,c(4,6,8,10,12)], crop)
colnames(crop) <- c("region","district","sector","cell", "village","survey","scode","lon","lat","maize","wheat","rice","potato","cassava","bean")

# Project GeoSurvey coords to grid CRS
crop.proj <- as.data.frame(project(cbind(crop$lon, crop$lat), "+proj=laea +ellps=WGS84 +lon_0=20 +lat_0=5 +units=m +no_defs"))
colnames(crop.proj) <- c("x","y")
crop <- cbind(crop, crop.proj)
coordinates(crop) <- ~x+y
projection(crop) <- projection(grids)

# Extract gridded variables at GeoSurvey locations
cropgrid <- extract(grids, crop)
gsdat <- as.data.frame(cbind(crop, cropgrid))

# Randomize dataframe
set.seed(1235813)
gsdat <- gsdat[sample(1:nrow(gsdat)), ]

# Write out data frame
write.csv(gsdat, "./Priority_crops/Results/RW_priority_crop_dist.csv", row.names = F)

# Plot combined crop survey locations
w <- leaflet() %>%
  setView(lng = mean(gsdat$lon), lat = mean(gsdat$lat), zoom = 8) %>%
  addProviderTiles(providers$OpenStreetMap.Mapnik) %>%
  addCircleMarkers(gsdat$lon, gsdat$lat, clusterOptions = markerClusterOptions())
saveWidget(w, './Priority_crops/Results/RW_crop_locs.html', selfcontained = T) ## save widget
w ## plot widget 
```

# Ensemble machine learning based mapping with `caret` and `caretEnsemble`

The following chunks calibrate crop presence/absence distribution observations using different machine learning algorithms (MLAs) to various spatial feature inputs using the [caret](https://topepo.github.io/caret/) and [caretEnsemble](https://cran.r-project.org/web/packages/caretEnsemble/index.html) packages. The main idea is to train several potentially competing algorithms with [k-fold cross-validation](https://en.wikipedia.org/wiki/Cross-validation_(statistics)). At the end of the model training processes, the various models are ensembled (combined or stacked) on an *independent validation dataset*.

To start the fitting processes covered in this section, the next chunk scrubs some of the extraneous objects in memory, removes any incomplete cases, sets-up labels and features, and creates a randomized (80:20%) partition between the training and validation dataframes.

```{r}
# Remove extraneous objects & incomplete cases
rm(list=setdiff(ls(), c("gsdat","grids","glist"))) ## scrub extraneous objects in memory
gsdat <- gsdat[complete.cases(gsdat[ ,c(19:67)]),] ## removes incomplete cases

# Set calibration/validation set randomization seed
seed <- 12358
set.seed(seed)

# Split data into calibration and validation sets
gsIndex <- createDataPartition(gsdat$bean, p = 4/5, list = F, times = 1)
gs_cal <- gsdat[ gsIndex,]
gs_val <- gsdat[-gsIndex,]

# GeoSurvey calibration labels
labs <- c("bean") ## insert other presence/absence labels here (e.g. maize, wheat, rice, potato or cassava)
lcal <- as.vector(t(gs_cal[labs]))

# Raster calibration features
fcal <- gs_cal[ ,19:38,42:67]
```

Note that we are using the observed `bean` distribution data here. You can also substitute other crops as labels and specify those with the `labs` variable in the chunk above. The additional labels are included in the `RW_soil_data.csv` data file, but we shall leave those for you to explore. Presented next are some starter models, which we consider to be *contrasting* both in terms of the gridded calibration features that are used, as well as the MLAs that are used in fitting the observational data to those.
